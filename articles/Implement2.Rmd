---
title: "Implementing Scrublet in R"
output: html_document
date: "2024-02-02"
always_allow_html: true
editor_options: 
  
  chunk_output_type: console
---

# Installation of packages

Note that this notebook was run using Rstudio enabling both R and Python environments to be maintained throughout.

### Installing scrubletR

You will need to have the devtools package installed...

```{r, eval=F}
devtools::install_github("furlan-lab/scrubletR")
```


```{r, include=F}
rm(list=ls())
library(reticulate)
library(scrubletR)
# reticulate::use_condaenv("reticulate")
```
### Loading reticulate

Not for the faint of heart...  You can read about getting python working from within R [here] (https://rstudio.github.io/reticulate/).  You can either activate your reticulate environment and use 'pip install scrublet' to install scrublet or try from R as below.  I use conda (reluctantly) and could not get it to install from in R
```{r, eval=F}
library(reticulate)
py_config()
py_install("scrublet")

```

I had to do this in the terminal after creating a new conda environment called 'reticulate'.

```{bash, eval=F}
conda activate reticulate
pip install scrublet
```

Regardless of how you do it, you can check that it is installed using this from R.  If you are successful, you will get no output.
```{r}
py_run_string("import scrublet")
```

Failure will look something like this
```{r, eval=F}
py_run_string("import scrubletoops")
```


# Comparing Implementations

Ok with working R and python versions of Scrublet, let's go over the differences.  First let's load data


### Load data

```{r, dpi=300, fig.height=4, fig.width = 6, warning=F, message=F}

suppressPackageStartupMessages({
  library(viewmastRust)
  library(Seurat)
  library(scCustomize)
  library(Matrix)
})

if(grepl("^gizmo", Sys.info()["nodename"])){
  ROOT_DIR2<-"/fh/fast/furlan_s/grp/data/ddata/BM_data"
} else {
  ROOT_DIR2<-"/Users/sfurlan/Library/CloudStorage/OneDrive-SharedLibraries-FredHutchinsonCancerCenter/Furlan_Lab - General/experiments/patient_marrows/aggr/cds/indy"
}

#query dataset
seuP<-readRDS(file.path(ROOT_DIR2, "220831_WC1.RDS"))
DimPlot_scCustom(seuP)

counts_matrix<-t(seuP@assays$RNA@counts[,1:2000])
#counts_matrix<-t(seuP@assays$RNA@counts)
```

## First step

The first step in scrublet data processing is size factor normalization.  Let's see how the normalized counts compare across the two implementations.  In the next block, I have run the scrublet pipeline through normalization and saved the counts in the R environment as "py_E_obs_norm"

```{python}
import numpy as np
import scrublet as scr
scrub = scr.Scrublet(r.counts_matrix)

##set params
synthetic_doublet_umi_subsampling=1.0
use_approx_neighbors=True
distance_metric='euclidean'
get_doublet_neighbor_parents=False
min_counts=3
min_cells=3
min_gene_variability_pctl=85
log_transform=False
mean_center=True,
normalize_variance=True
n_prin_comps=30
svd_solver='arpack'
verbose=True

#clear data in object
scrub._E_sim = None
scrub._E_obs_norm = None
scrub._E_sim_norm = None
scrub._gene_filter = np.arange(scrub._E_obs.shape[1])

#run normalize
scr.pipeline_normalize(scrub)

#capture size factor normalized counts
r.py_E_obs_norm = scrub._E_obs_norm.data


```

### Run scrubletR size factor normalization

To see how the sets of counts compare, we can similarly run scrubletR normalization and correlate a sample (n=5000) of the log transformed counts using ggplot.  Unsurprisingly they are not different.

```{r}

#In R
#set params
synthetic_doublet_umi_subsampling = 1.0
use_approx_neighbors = TRUE
distance_metric = 'euclidean'
get_doublet_neighbor_parents = FALSE
min_counts = 3
min_cells = 3
min_gene_variability_pctl = 85
log_transform = FALSE
mean_center = T
normalize_variance = T
n_prin_comps = 30
verbose = TRUE


#instantiate object
scr<-Scrublet$new(counts_matrix = counts_matrix)

scr$pipeline_normalize()

ix<-sample(1:length(scr$E_obs_norm@x), 5000)
ggplot(data.frame(x=log(scr$E_obs_norm@x[ix]), y = log(py_E_obs_norm[ix])), aes(x=x, y=y))+geom_point(size = 0.01)+xlab("scrubletR size-factor normalized counts")+ylab("scrublet (python) size-factor normalized counts")+theme_bw()


scr$E_obs_norm@x[ix][1:10]
py_E_obs_norm[ix][1:10]


```

## Second step

Next in the pipeline is to select a subset of features with the highest variable expression.  The default is set to find the set of features that exhibit expression variance in the above the 85th percentile as measured using the v-statistic.

```{python}
scrub._gene_filter = scr.filter_genes(scrub._E_obs_norm,
                                        min_counts=min_counts,
                                        min_cells=min_cells,
                                        min_vscore_pctl=min_gene_variability_pctl, show_vscore_plot=True)
v_scores, CV_eff, CV_input, gene_ix, mu_gene, FF_gene, a, b = scr.get_vscores(scrub._E_obs_norm)
r.py_vscores = v_scores
min_vscore_pctl=min_gene_variability_pctl
ix2 = v_scores>0
v_scores = v_scores[ix2]
gene_ix = gene_ix[ix2]
mu_gene = mu_gene[ix2]
FF_gene = FF_gene[ix2]
min_vscore = np.percentile(v_scores, min_vscore_pctl)
final_ix = (((scrub._E_obs_norm[:,gene_ix] >= min_counts).sum(0).A.squeeze() >= min_cells) & (v_scores >= min_vscore))
    
#import inspect
#lines = inspect.getsource(scr.filter_genes)
#print(lines)

```


## Problem #1

V-scores are different between R and python
```{r}
scr$pipeline_get_gene_filter()

debug(get_vscores)
vscores_result<-get_vscores(scr$E_obs_norm)
Vscores <- as.numeric(vscores_result$v_scores)
# ggplot(data.frame(x=log(Vscores), y = log(py_vscores)), aes(x=x, y=y))+geom_point(size = 0.01)+xlab("scrubletR vscores")+ylab("scrublet (python) vscores")+theme_bw()

df<-data.frame(vscore_R=log(Vscores), vscore_py = log(py_vscores), indices_py=1:length(Vscores) %in% (py$gene_ix+1), indices_R=1:length(Vscores) %in% vscores_result$gene_ix)

df$selected_cat<-factor(with(df, 2*indices_py + indices_R + 1))
levels(df$selected_cat)<-c("neither", "both")

#ggplot(df, aes(x=vscore_R, y=vscore_py, color = selected_cat))+geom_point(size = 0.01)+theme_bw()

gene_ix <- vscores_result$gene_ix
mu_gene <- vscores_result$mu_gene
FF_gene <- vscores_result$FF_gene
a <- vscores_result$a
b <- vscores_result$b

ix2 <- Vscores > 0
Vscores <- Vscores[ix2]
gene_ix <- gene_ix[ix2]
mu_gene <- mu_gene[ix2]
FF_gene <- FF_gene[ix2]

min_vscore_pctl=min_gene_variability_pctl
min_vscore <- quantile(Vscores, prob = min_vscore_pctl / 100)

ix <- ((colSums(scr$E_obs_norm[, gene_ix] >= min_counts) >= min_cells) & (Vscores >= min_vscore))

df$selected_R<-ix
df$selected_py<-py$final_ix
df$selected_cat<-factor(with(df, 2*selected_py + selected_R + 1))
levels(df$selected_cat)<-c("neither", "py_only", "both")
ggplot(df, aes(x=vscore_R, y=vscore_py, color = selected_cat))+geom_point(size = 1)+theme_bw()

```

## A closer look at V scores

```{r}
new_v <- get_vscores(scr$E_obs_norm, method = "CG", hessian = T)$v_scores


df<-data.frame(new_vscore_R=log(new_v), vscore_py = log(py_vscores), indices_py=1:length(Vscores) %in% (py$gene_ix+1), indices_R=1:length(Vscores) %in% vscores_result$gene_ix)
df$selected_R<-ix
df$selected_py<-py$final_ix
df$selected_cat<-factor(with(df, 2*selected_py + selected_R + 1))
levels(df$selected_cat)<-c("neither", "py_only", "both")
ggplot(df, aes(x=new_vscore_R, y=vscore_py, color = selected_cat))+geom_point(size = 1)+theme_bw()
```


```{r}
min_mean = 0
nBins = 50
fit_percentile = 0.1
error_wt = 1
method=c("Nelder-Mead", "BFGS", "CG", "L-BFGS-B", "SANN","Brent")
hessian=F


E<-scr$E_obs_norm
ncell <- nrow(E)
mu_gene <- colMeans(E)
gene_ix <- which(mu_gene > min_mean)
mu_gene <- mu_gene[gene_ix]

tmp <- E[, gene_ix]
tmp <- tmp^2
var_gene <- colMeans(tmp) - mu_gene^2
rm(tmp)

FF_gene <- var_gene / mu_gene

data_x <- log(mu_gene)
data_y <- log(FF_gene / mu_gene)


  result <- runningquantile(data_x, data_y, fit_percentile, nBins)
  x <- result$xOut[!is.na(result$yOut)]
  y <- result$yOut[!is.na(result$yOut)]

  gLog <- function(input1, input2, input3) {
    log(input2 * exp(-input1) + input3)
  }

  hist_data <- hist(log(FF_gene[mu_gene > 0]), breaks = 200, plot = F)
  b <- hist_data$breaks[-length(hist_data$breaks)] + diff(hist_data$breaks) / 2
  max_ix <- which.max(hist_data$counts)
  c <- max(exp(b[max_ix]), 1)

  errFun <- function(b2) {
    sum(abs(gLog(x, c, b2) - y)^error_wt)
  }


  b0 <- 0.1
###CHANGED THIS SCOTT
   b<- optimise(errFun, c(b0, 1e30*b0))$minimum
  a <- c / (1 + b) - 1

  v_scores <- FF_gene / ((1 + a) * (1 + b) + b * mu_gene)
  CV_eff <- sqrt((1 + a) * (1 + b) - 1)
  CV_input <- sqrt(b)


```

```{python}
import scipy
##debugging v_scroes fn
def runningquantile(x, y, p, nBins):

    ind = np.argsort(x)
    x = x[ind]
    y = y[ind]

    dx = (x[-1] - x[0]) / nBins
    xOut = np.linspace(x[0]+dx/2, x[-1]-dx/2, nBins)

    yOut = np.zeros(xOut.shape)

    for i in range(len(xOut)):
        ind = np.nonzero((x >= xOut[i]-dx/2) & (x < xOut[i]+dx/2))[0]
        if len(ind) > 0:
            yOut[i] = np.percentile(y[ind], p)
        else:
            if i > 0:
                yOut[i] = yOut[i-1]
            else:
                yOut[i] = np.nan

    return xOut, yOut
##params

min_mean=0
nBins=50
fit_percentile=0.1
error_wt=1

##
E = scrub._E_obs_norm
ncell = E.shape[0]
mu_gene = E.mean(axis=0).A.squeeze()

gene_ix = np.nonzero(mu_gene > min_mean)[0]
mu_gene = mu_gene[gene_ix]

tmp = E[:,gene_ix]
tmp.data **= 2
var_gene = tmp.mean(axis=0).A.squeeze() - mu_gene ** 2
del tmp
var_gene[0:9]
FF_gene = var_gene / mu_gene

data_x = np.log(mu_gene)
data_y = np.log(FF_gene / mu_gene)

    x, y = runningquantile(data_x, data_y, fit_percentile, nBins)
    x = x[~np.isnan(y)]
    y = y[~np.isnan(y)]

    gLog = lambda input: np.log(input[1] * np.exp(-input[0]) + input[2])
    h,b = np.histogram(np.log(FF_gene[mu_gene>0]), bins=200)
    b = b[:-1] + np.diff(b)/2
    max_ix = np.argmax(h)
    c = np.max((np.exp(b[max_ix]), 1))
    errFun = lambda b2: np.sum(abs(gLog([x,c,b2])-y) ** error_wt)
    b0 = 0.1
    b = scipy.optimize.fmin(func = errFun, x0=[b0], disp=False)
    a = c / (1+b) - 1


    v_scores = FF_gene / ((1+a)*(1+b) + b * mu_gene);
    CV_eff = np.sqrt((1+a)*(1+b) - 1);
    CV_input = np.sqrt(b);

```

## Appendix
```{r Appendix}
sessionInfo()
getwd()
```
