<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="scrubletR">
<title>Implementing Scrublet in R • scrubletR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/IBM_Plex_Sans-0.4.8/font.css" rel="stylesheet">
<link href="../deps/Fira_Mono-0.4.8/font.css" rel="stylesheet">
<link href="../deps/Alegreya_Sans_SC-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Implementing Scrublet in R">
<meta property="og:description" content="scrubletR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-secondary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">scrubletR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Get Started</h6>
    <a class="dropdown-item" href="../articles/HowTo.html">How to ScrubletR</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Advanced</h6>
    <a class="dropdown-item" href="../articles/ImplementationHassles.html">Implementing Scrublet in R</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="http://twitter.com/scottfurlan" aria-label="Twitter">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/furlan-lab/scrubletR" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Implementing Scrublet in R</h1>
            
            <h4 data-toc-skip class="date">2024-02-02</h4>
      
      
      <div class="d-none name"><code>ImplementationHassles.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="installation-of-packages">Installation of packages<a class="anchor" aria-label="anchor" href="#installation-of-packages"></a>
</h2>
<p>Note that this notebook was run using Rstudio enabling both R and
Python environments to be maintained throughout.</p>
<div class="section level4">
<h4 id="installing-scrubletr">Installing scrubletR<a class="anchor" aria-label="anchor" href="#installing-scrubletr"></a>
</h4>
<p>You will need to have the devtools package installed…</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"furlan-lab/scrubletR"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="loading-reticulate">Loading reticulate<a class="anchor" aria-label="anchor" href="#loading-reticulate"></a>
</h4>
<p>Not for the faint of heart… You can read about getting python working
from within R [here] (<a href="https://rstudio.github.io/reticulate/" class="external-link uri">https://rstudio.github.io/reticulate/</a>). You can either
activate your reticulate environment and use ‘pip install scrublet’ to
install scrublet or try from R as below. I use conda (reluctantly) and
could not get it to install from in R</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">py_config</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_install.html" class="external-link">py_install</a></span><span class="op">(</span><span class="st">"scrublet"</span><span class="op">)</span></span></code></pre></div>
<p>I had to do this in the terminal after creating a new conda
environment called ‘reticulate’.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">conda</span> activate reticulate</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="ex">pip</span> install scrublet</span></code></pre></div>
<p>Regardless of how you do it, you can check that it is installed using
this from R. If you are successful, you will get no output.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_run.html" class="external-link">py_run_string</a></span><span class="op">(</span><span class="st">"import scrublet"</span><span class="op">)</span></span></code></pre></div>
<p>Failure will look something like this</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_run.html" class="external-link">py_run_string</a></span><span class="op">(</span><span class="st">"import scrubletoops"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-implementations">Comparing Implementations<a class="anchor" aria-label="anchor" href="#comparing-implementations"></a>
</h2>
<p>Ok with working R and python versions of Scrublet, let’s go over the
differences. First let’s load data</p>
<div class="section level4">
<h4 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://furlan-lab.github.io/viewmastRust/" class="external-link">viewmastRust</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/samuel-marsh/scCustomize" class="external-link">scCustomize</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^gizmo"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ROOT_DIR2</span><span class="op">&lt;-</span><span class="st">"/fh/fast/furlan_s/grp/data/ddata/BM_data"</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">ROOT_DIR2</span><span class="op">&lt;-</span><span class="st">"/Users/sfurlan/Library/CloudStorage/OneDrive-SharedLibraries-FredHutchinsonCancerCenter/Furlan_Lab - General/experiments/patient_marrows/aggr/cds/indy"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#query dataset</span></span>
<span><span class="va">seuP</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">ROOT_DIR2</span>, <span class="st">"220831_WC1.RDS"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://samuel-marsh.github.io/scCustomize/reference/DimPlot_scCustom.html" class="external-link">DimPlot_scCustom</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-7-1.png" width="100%"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#counts_matrix&lt;-t(seuP@assays$RNA@counts[,1:2000])</span></span>
<span><span class="va">counts_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="first-step">First step<a class="anchor" aria-label="anchor" href="#first-step"></a>
</h3>
<p>The first step in scrublet data processing is size factor
normalization. Let’s see how the normalized counts compare across the
two implementations. In the next block, I have run the scrublet pipeline
through normalization and saved the counts in the R environment as
“py_E_obs_norm”</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="im">import</span> scrublet <span class="im">as</span> scr</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>scrub <span class="op">=</span> scr.Scrublet(r.counts_matrix)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">##set params</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>synthetic_doublet_umi_subsampling<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>use_approx_neighbors<span class="op">=</span><span class="va">True</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>distance_metric<span class="op">=</span><span class="st">'euclidean'</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>get_doublet_neighbor_parents<span class="op">=</span><span class="va">False</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>min_counts<span class="op">=</span><span class="dv">3</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>min_cells<span class="op">=</span><span class="dv">3</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>min_gene_variability_pctl<span class="op">=</span><span class="dv">85</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>log_transform<span class="op">=</span><span class="va">False</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>mean_center<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>normalize_variance<span class="op">=</span><span class="va">True</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>n_prin_comps<span class="op">=</span><span class="dv">30</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>svd_solver<span class="op">=</span><span class="st">'arpack'</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>random_state <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#clear data in object</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>scrub._E_sim <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>scrub._E_obs_norm <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>scrub._E_sim_norm <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>scrub._gene_filter <span class="op">=</span> np.arange(scrub._E_obs.shape[<span class="dv">1</span>])</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a><span class="co">#run normalize</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>scr.pipeline_normalize(scrub)</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a><span class="co">#capture size factor normalized counts</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>r.py_E_obs_norm <span class="op">=</span> scrub._E_obs_norm.data</span></code></pre></div>
<div class="section level4">
<h4 id="run-scrubletr-size-factor-normalization">Run scrubletR size factor normalization<a class="anchor" aria-label="anchor" href="#run-scrubletr-size-factor-normalization"></a>
</h4>
<p>To see how the sets of counts compare, we can similarly run scrubletR
normalization and correlate a sample (n=5000) of the log transformed
counts using ggplot. Unsurprisingly they are not different.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#In R</span></span>
<span><span class="co">#set params</span></span>
<span><span class="va">synthetic_doublet_umi_subsampling</span> <span class="op">=</span> <span class="fl">1.0</span></span>
<span><span class="va">use_approx_neighbors</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">distance_metric</span> <span class="op">=</span> <span class="st">'euclidean'</span></span>
<span><span class="va">get_doublet_neighbor_parents</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">min_counts</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">min_cells</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">min_gene_variability_pctl</span> <span class="op">=</span> <span class="fl">85</span></span>
<span><span class="va">log_transform</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">mean_center</span> <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">normalize_variance</span> <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">n_prin_comps</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">verbose</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span></span>
<span><span class="co">#instantiate object</span></span>
<span><span class="va">scr</span><span class="op">&lt;-</span><span class="va"><a href="../reference/Scrublet.html">Scrublet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>counts_matrix <span class="op">=</span> <span class="va">counts_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_normalize</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ix</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">@</span><span class="va">x</span><span class="op">)</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">@</span><span class="va">x</span><span class="op">[</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">py_E_obs_norm</span><span class="op">[</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">+</span><span class="fu">xlab</span><span class="op">(</span><span class="st">"scrubletR size-factor normalized counts"</span><span class="op">)</span><span class="op">+</span><span class="fu">ylab</span><span class="op">(</span><span class="st">"scrublet (python) size-factor normalized counts"</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-9-1.png" width="100%"></p>
</div>
</div>
<div class="section level3">
<h3 id="second-step">Second step<a class="anchor" aria-label="anchor" href="#second-step"></a>
</h3>
<p>Next in the pipeline is to select a subset of features with the
highest variable expression. The default is set to find the set of
features that exhibit expression variance in the above the 85th
percentile as measured using the v-statistic.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>genefilter <span class="op">=</span> scr.filter_genes(scrub._E_obs_norm,</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>                                        min_counts<span class="op">=</span>min_counts,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>                                        min_cells<span class="op">=</span>min_cells,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>                                        min_vscore_pctl<span class="op">=</span>min_gene_variability_pctl, show_vscore_plot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>v_scores, CV_eff, CV_input, gene_ix, mu_gene, FF_gene, a, b <span class="op">=</span> scr.get_vscores(scrub._E_obs_norm)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>r.py_vscores <span class="op">=</span> v_scores</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>min_vscore_pctl<span class="op">=</span>min_gene_variability_pctl</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>ix2 <span class="op">=</span> v_scores<span class="op">&gt;</span><span class="dv">0</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>v_scores <span class="op">=</span> v_scores[ix2]</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>gene_ix <span class="op">=</span> gene_ix[ix2]</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>mu_gene <span class="op">=</span> mu_gene[ix2]</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>FF_gene <span class="op">=</span> FF_gene[ix2]</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>min_vscore <span class="op">=</span> np.percentile(v_scores, min_vscore_pctl)</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>final_ix <span class="op">=</span> (((scrub._E_obs_norm[:,gene_ix] <span class="op">&gt;=</span> min_counts).<span class="bu">sum</span>(<span class="dv">0</span>).A.squeeze() <span class="op">&gt;=</span> min_cells) <span class="op">&amp;</span> (v_scores <span class="op">&gt;=</span> min_vscore))</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co">#import inspect</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co">#lines = inspect.getsource(scr.filter_genes)</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co">#print(lines)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="problem-1">Problem #1<a class="anchor" aria-label="anchor" href="#problem-1"></a>
</h3>
<p>V-scores are slightly different between R and python. The correlation
is pretty good howewever and this likely won’t affect performance too
much</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#scr$pipeline_get_gene_filter()</span></span>
<span></span>
<span></span>
<span><span class="va">vscores_result</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_vscores.html">get_vscores</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span></span>
<span><span class="va">Vscores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">vscores_result</span><span class="op">$</span><span class="va">v_scores</span><span class="op">)</span></span>
<span><span class="co"># ggplot(data.frame(x=log(Vscores), y = log(py_vscores)), aes(x=x, y=y))+geom_point(size = 0.01)+xlab("scrubletR vscores")+ylab("scrublet (python) vscores")+theme_bw()</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>vscore_R<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Vscores</span><span class="op">)</span>, vscore_py <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">py_vscores</span><span class="op">)</span>, indices_py<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vscores</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">gene_ix</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, indices_R<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Vscores</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">gene_ix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">selected_cat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">2</span><span class="op">*</span><span class="va">indices_py</span> <span class="op">+</span> <span class="va">indices_R</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">selected_cat</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"neither"</span>, <span class="st">"both"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#ggplot(df, aes(x=vscore_R, y=vscore_py, color = selected_cat))+geom_point(size = 0.01)+theme_bw()</span></span>
<span></span>
<span><span class="va">gene_ix</span> <span class="op">&lt;-</span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">gene_ix</span></span>
<span><span class="va">mu_gene</span> <span class="op">&lt;-</span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">mu_gene</span></span>
<span><span class="va">FF_gene</span> <span class="op">&lt;-</span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">FF_gene</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">a</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">vscores_result</span><span class="op">$</span><span class="va">b</span></span>
<span></span>
<span><span class="va">ix2</span> <span class="op">&lt;-</span> <span class="va">Vscores</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span><span class="va">Vscores</span> <span class="op">&lt;-</span> <span class="va">Vscores</span><span class="op">[</span><span class="va">ix2</span><span class="op">]</span></span>
<span><span class="va">gene_ix</span> <span class="op">&lt;-</span> <span class="va">gene_ix</span><span class="op">[</span><span class="va">ix2</span><span class="op">]</span></span>
<span><span class="va">mu_gene</span> <span class="op">&lt;-</span> <span class="va">mu_gene</span><span class="op">[</span><span class="va">ix2</span><span class="op">]</span></span>
<span><span class="va">FF_gene</span> <span class="op">&lt;-</span> <span class="va">FF_gene</span><span class="op">[</span><span class="va">ix2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">min_vscore_pctl</span><span class="op">=</span><span class="va">min_gene_variability_pctl</span></span>
<span><span class="va">min_vscore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Vscores</span>, prob <span class="op">=</span> <span class="va">min_vscore_pctl</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ix</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">[</span>, <span class="va">gene_ix</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="va">min_counts</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">min_cells</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Vscores</span> <span class="op">&gt;=</span> <span class="va">min_vscore</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">selected_R</span><span class="op">&lt;-</span><span class="va">ix</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">selected_py</span><span class="op">&lt;-</span><span class="va">py</span><span class="op">$</span><span class="va">final_ix</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">selected_cat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">2</span><span class="op">*</span><span class="va">selected_py</span> <span class="op">+</span> <span class="va">selected_R</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">selected_cat</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"neither"</span>, <span class="st">"r_only"</span>, <span class="st">"py_only"</span>, <span class="st">"both"</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">vscore_R</span>, y<span class="op">=</span><span class="va">vscore_py</span>, color <span class="op">=</span> <span class="va">selected_cat</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-11-1.png" width="100%"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">selected_cat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## neither  r_only py_only    both </span></span>
<span><span class="co">##   22149      10       5    2472</span></span></code></pre>
<div class="section level4">
<h4 id="highly-variant-features-using-r-method">Highly variant features using R method<a class="anchor" aria-label="anchor" href="#highly-variant-features-using-r-method"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_get_gene_filter</span><span class="op">(</span>plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-12-1.png" width="100%"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_apply_gene_filter</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="simulating-doublets">Simulating doublets<a class="anchor" aria-label="anchor" href="#simulating-doublets"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_doublet_ratio</span> <span class="op">=</span> <span class="fl">2.0</span></span>
<span><span class="va">synthetic_doublet_umi_subsampling</span> <span class="op">=</span> <span class="fl">1.0</span></span>
<span></span>
<span><span class="va">scr</span><span class="op">$</span><span class="fu">simulate_doublets</span><span class="op">(</span>sim_doublet_ratio<span class="op">=</span><span class="va">sim_doublet_ratio</span>, synthetic_doublet_umi_subsampling<span class="op">=</span><span class="va">synthetic_doublet_umi_subsampling</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_normalize</span><span class="op">(</span>postnorm_total<span class="op">=</span><span class="fl">1e6</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>scr.pipeline_get_gene_filter(scrub)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>scr.pipeline_apply_gene_filter(scrub)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>scrub.simulate_doublets(sim_doublet_ratio<span class="op">=</span>scrub.sim_doublet_ratio, synthetic_doublet_umi_subsampling<span class="op">=</span>synthetic_doublet_umi_subsampling)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>scr.pipeline_normalize(scrub, postnorm_total<span class="op">=</span><span class="fl">1e6</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>r.py_Esimnorm <span class="op">=</span> scrub._E_sim_norm</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>gene_filter <span class="op">=</span> scrub._gene_filter</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>r.py_E_obs_norm <span class="op">=</span> scrub._E_obs_norm</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>scrub_preZ <span class="op">=</span> copy.deepcopy(scrub)</span></code></pre></div>
<p>#Let’s umap</p>
<p>Here we will brind the pseudo doublets with the original count matrix
and visualize using UMAP across the two implemnetations. They look
similar.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="va">rcounts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span>, <span class="va">scr</span><span class="op">$</span><span class="va">E_sim_norm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">rcounts</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">)</span><span class="op">[</span><span class="va">scr</span><span class="op">$</span><span class="va">gene_filter</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rcounts</span><span class="op">)</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">rcounts</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">seuR</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">rcounts</span>, meta.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>celltype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"pseudodoublet"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rcounts</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">seuR</span> <span class="op">&lt;-</span><span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">seuR</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>npcs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html" class="external-link">ElbowPlot</a></span><span class="op">(</span><span class="va">seuR</span>, <span class="fl">50</span><span class="op">)</span> </span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-15-1.png" width="100%"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seuR</span><span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="va">seuR</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of nodes: 41742</span></span>
<span><span class="co">## Number of edges: 1409152</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Running Louvain algorithm...</span></span>
<span><span class="co">## Maximum modularity in 10 random starts: 0.8846</span></span>
<span><span class="co">## Number of communities: 27</span></span>
<span><span class="co">## Elapsed time: 9 seconds</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">seuR</span>, group.by <span class="op">=</span> <span class="st">"celltype"</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">polychrome</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">16</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"scrubletR"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-15-2.png" width="100%"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pycounts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">py_E_obs_norm</span>, <span class="va">py_Esimnorm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pycounts</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">)</span><span class="op">[</span><span class="va">py</span><span class="op">$</span><span class="va">gene_filter</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pycounts</span><span class="op">)</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pycounts</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">seuPy</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">pycounts</span>, meta.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>celltype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"pseudodoublet"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">seuP</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pycounts</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">seuPy</span> <span class="op">&lt;-</span><span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">seuPy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>npcs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html" class="external-link">ElbowPlot</a></span><span class="op">(</span><span class="va">seuPy</span>, <span class="fl">50</span><span class="op">)</span> </span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-15-3.png" width="100%"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seuPy</span><span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="va">seuPy</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of nodes: 41742</span></span>
<span><span class="co">## Number of edges: 1477580</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Running Louvain algorithm...</span></span>
<span><span class="co">## Maximum modularity in 10 random starts: 0.8791</span></span>
<span><span class="co">## Number of communities: 25</span></span>
<span><span class="co">## Elapsed time: 9 seconds</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">seuPy</span>, group.by <span class="op">=</span> <span class="st">"celltype"</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">polychrome</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">16</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Scrublet (python)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-15-4.png" width="100%"></p>
</div>
</div>
<div class="section level3">
<h3 id="z-scoring">Z-scoring<a class="anchor" aria-label="anchor" href="#z-scoring"></a>
</h3>
<p>The default scrublet pathway then performs a z-scaling procedure
across the data</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>scrub_preZ._E_obs_norm.shape</span></code></pre></div>
<pre><code><span><span class="co">## (13914, 2477)</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>gene_means <span class="op">=</span> scrub._E_obs_norm.mean(<span class="dv">0</span>)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>gene_stdevs <span class="op">=</span> np.sqrt(scr.sparse_var(scrub._E_obs_norm))</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>py_zscored <span class="op">=</span> scr.sparse_multiply((scrub._E_obs_norm <span class="op">-</span> gene_means).T, <span class="dv">1</span><span class="op">/</span>gene_stdevs).T</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-by-step">step by step<a class="anchor" aria-label="anchor" href="#step-by-step"></a>
</h3>
<p>####Step 1 calculate gene mean and stdev - look pretty similar</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span><span class="op">)</span> <span class="co">#######changed to column - IS CORRECT</span></span>
<span><span class="va">gene_stdev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu">scrubletR</span><span class="fu">:::</span><span class="fu"><a href="../reference/sparse_var.html">sparse_var</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span>, axis <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># print_py(gene_mean)</span></span>
<span><span class="co"># print_py(gene_stdev)</span></span>
<span><span class="co"># print_py(py$gene_means[1,])</span></span>
<span><span class="co"># print_py(py$gene_stdevs)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gene_mean</span>, <span class="va">py</span><span class="op">$</span><span class="va">gene_means</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>, stdev<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gene_stdev</span>, <span class="va">py</span><span class="op">$</span><span class="va">gene_stdevs</span><span class="op">)</span><span class="op">)</span>, impl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gene_mean</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Py"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">gene_means</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">mean</span>, fill<span class="op">=</span><span class="va">impl</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_density</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-17-1.png" width="100%"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gene_mean</span>, <span class="va">py</span><span class="op">$</span><span class="va">gene_means</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>, stdev<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gene_stdev</span>, <span class="va">py</span><span class="op">$</span><span class="va">gene_stdevs</span><span class="op">)</span><span class="op">)</span>, impl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gene_mean</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Py"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">gene_means</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">stdev</span>, fill<span class="op">=</span><span class="va">impl</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_density</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-17-2.png" width="100%"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#(same as py)</span></span></code></pre></div>
<p>####Step 2 subtract gene means</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>preZ_Eobs_norm <span class="op">=</span> scrub_preZ._E_obs_norm</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>step2 <span class="op">=</span> preZ_Eobs_norm <span class="op">-</span> preZ_Eobs_norm.mean(<span class="dv">0</span>) <span class="co"># this step is easy in python</span></span></code></pre></div>
<p>Here’s what you get in R with similarly structured code</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step2</span> <span class="op">=</span> <span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span> <span class="co"># this doesn't work as intended in R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span><span class="op">&lt;-</span><span class="cn">NULL</span></span>
<span></span>
<span><span class="va">step2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 10 x 10 Matrix of class "dgeMatrix"</span></span>
<span><span class="co">##              [,1]         [,2]        [,3]          [,4]         [,5]</span></span>
<span><span class="co">##  [1,]  -1.0294501   -1.2815507  -6.4029111    -3.3582206   -2.5414889</span></span>
<span><span class="co">##  [2,]  -0.1149148   -2.7254183 -47.6427631    98.4509273 -202.0442150</span></span>
<span><span class="co">##  [3,]  -0.5069102  -26.1563220  -7.0442071    -4.8296559 -158.6784346</span></span>
<span><span class="co">##  [4,] -47.4869206   -4.9858189  -0.4297543   -57.3229486   -0.5091509</span></span>
<span><span class="co">##  [5,]  -2.7516240 -483.2102680 -76.2160384    -7.5710177   -3.4020053</span></span>
<span><span class="co">##  [6,]  -2.8772205   -6.8049528 -12.9709248    -0.4681139   -0.4705826</span></span>
<span><span class="co">##  [7,] -28.4278954 -292.2953822  -0.4011992 -2117.7123348   -0.5806434</span></span>
<span><span class="co">##  [8,]  -0.4037443   -2.1122108  -0.3693642   -19.3384333   -0.5864083</span></span>
<span><span class="co">##  [9,]  -1.5197192   -0.5371283  -0.5010018   -27.5754728   -1.9881826</span></span>
<span><span class="co">## [10,]  -0.7596383   -1.8024743 -34.4138321    -0.3174581  -45.4030655</span></span>
<span><span class="co">##                [,6]         [,7]         [,8]         [,9]        [,10]</span></span>
<span><span class="co">##  [1,]   -0.66006144   -3.7521545   -3.5579435 -168.4110083  -12.7967736</span></span>
<span><span class="co">##  [2,]   -0.51114543  -15.4614631  -68.8341475 -161.6263527   -2.8791465</span></span>
<span><span class="co">##  [3,]   -1.48972359 -430.6828817   -9.0642243   -8.6457439 -171.5477283</span></span>
<span><span class="co">##  [4,]   -0.52020704   -0.5181809 -335.3768468  -32.3952104   -1.3697266</span></span>
<span><span class="co">##  [5,]   -0.17273834   -0.6467012   -4.0768245  -99.6551555  -19.9285008</span></span>
<span><span class="co">##  [6,] -125.70835424   -2.4425953 -259.9421287   -9.7549442   -0.3627671</span></span>
<span><span class="co">##  [7,]   -0.09408157  -10.9057669  -15.1845578   -0.7617508 -156.7997910</span></span>
<span><span class="co">##  [8,]   -8.04110572  -41.6719108   -0.5136189  -17.0759625   -0.2073675</span></span>
<span><span class="co">##  [9,]   -0.95256054  417.9444652  -39.4990708   -0.4441260   -1.8115952</span></span>
<span><span class="co">## [10,] -206.12649988  128.0461667   -9.9702641 -224.8581777   -5.8393548</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">step2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]       [,2]       [,3]      [,4]      [,5]     [,6]     [,7]</span></span>
<span><span class="co">##  [1,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [2,] -1.02945 -0.1149148 -0.5069102  52.62320 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [3,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [4,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [5,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [6,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [7,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [8,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [9,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 389.8072</span></span>
<span><span class="co">## [10,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 115.0030</span></span>
<span><span class="co">##             [,8]      [,9]      [,10]</span></span>
<span><span class="co">##  [1,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [2,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [3,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [4,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [5,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [6,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [7,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [8,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [9,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">## [10,] -0.4037443 -1.519719 -0.7596383</span></span></code></pre>
<div class="section level5">
<h5 id="turns-out-r-has-some-peculiarities-and-for-subtracting-a-vector-element-wise-from-the-column-values-of-matrix-we-must-first-create-a-matrix-duplicating-the-desired-subtracted-values-down-all-the-rows--simply-subtracting-the-vector-in-this-case-of-gene-means-from-each-column-gene-of-the-matrix-cannot-be-done-using-simply-matrix---vector-in-python-the-subtraction-using-numpy-is-much-easier">turns out R has some peculiarities and for subtracting a vector
element-wise from the column values of matrix we must first create a
matrix duplicating the desired subtracted values down all the rows.
Simply subtracting the vector (in this case of gene means from each
column (gene) of the matrix cannot be done using simply matrix - vector)
In python, the subtraction using numpy is much easier…<a class="anchor" aria-label="anchor" href="#turns-out-r-has-some-peculiarities-and-for-subtracting-a-vector-element-wise-from-the-column-values-of-matrix-we-must-first-create-a-matrix-duplicating-the-desired-subtracted-values-down-all-the-rows--simply-subtracting-the-vector-in-this-case-of-gene-means-from-each-column-gene-of-the-matrix-cannot-be-done-using-simply-matrix---vector-in-python-the-subtraction-using-numpy-is-much-easier"></a>
</h5>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">step2</span> <span class="op">=</span> <span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span> <span class="op">-</span> <span class="va">sm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span><span class="op">&lt;-</span><span class="cn">NULL</span></span>
<span></span>
<span><span class="va">step2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 10 x 10 Matrix of class "dgeMatrix"</span></span>
<span><span class="co">##           [,1]       [,2]       [,3]      [,4]      [,5]     [,6]     [,7]</span></span>
<span><span class="co">##  [1,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [2,] -1.02945 -0.1149148 -0.5069102  52.62320 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [3,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [4,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [5,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [6,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [7,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [8,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [9,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 389.8072</span></span>
<span><span class="co">## [10,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 115.0030</span></span>
<span><span class="co">##             [,8]      [,9]      [,10]</span></span>
<span><span class="co">##  [1,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [2,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [3,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [4,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [5,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [6,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [7,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [8,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [9,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">## [10,] -0.4037443 -1.519719 -0.7596383</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">step2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]       [,2]       [,3]      [,4]      [,5]     [,6]     [,7]</span></span>
<span><span class="co">##  [1,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [2,] -1.02945 -0.1149148 -0.5069102  52.62320 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [3,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [4,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [5,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [6,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [7,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [8,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 -28.4279</span></span>
<span><span class="co">##  [9,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 389.8072</span></span>
<span><span class="co">## [10,] -1.02945 -0.1149148 -0.5069102 -47.48692 -2.751624 -2.87722 115.0030</span></span>
<span><span class="co">##             [,8]      [,9]      [,10]</span></span>
<span><span class="co">##  [1,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [2,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [3,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [4,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [5,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [6,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [7,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [8,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">##  [9,] -0.4037443 -1.519719 -0.7596383</span></span>
<span><span class="co">## [10,] -0.4037443 -1.519719 -0.7596383</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="step-3-complete-zscoring">Step 3 complete zscoring<a class="anchor" aria-label="anchor" href="#step-3-complete-zscoring"></a>
</h3>
<p>Looks good</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>step3 <span class="op">=</span> scr.sparse_multiply((step2).T, <span class="dv">1</span><span class="op">/</span>gene_stdevs).T</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>scr.pipeline_zscore(scrub)</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step3</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">scrubletR</span><span class="fu">:::</span><span class="fu"><a href="../reference/sparse_multiply.html">sparse_multiply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">step2</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">gene_stdev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">step3</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 10 x 10 Matrix of class "dgeMatrix"</span></span>
<span><span class="co">##             [,1]        [,2]        [,3]       [,4]        [,5]        [,6]</span></span>
<span><span class="co">##  [1,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [2,] -0.0501001 -0.01529958 -0.03374151  0.3859579 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [3,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [4,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [5,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [6,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [7,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [8,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [9,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">## [10,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##             [,7]        [,8]        [,9]       [,10]</span></span>
<span><span class="co">##  [1,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [2,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [3,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [4,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [5,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [6,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [7,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [8,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [9,]  3.5854137 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">## [10,]  1.0577878 -0.03381616 -0.07002316 -0.04718872</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">step3</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##             [,1]        [,2]        [,3]       [,4]        [,5]        [,6]</span></span>
<span><span class="co">##  [1,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [2,] -0.0501001 -0.01529958 -0.03374151  0.3859579 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [3,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [4,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [5,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [6,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [7,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [8,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##  [9,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">## [10,] -0.0501001 -0.01529958 -0.03374151 -0.3482865 -0.07549728 -0.07793504</span></span>
<span><span class="co">##             [,7]        [,8]        [,9]       [,10]</span></span>
<span><span class="co">##  [1,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [2,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [3,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [4,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [5,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [6,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [7,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [8,] -0.2614774 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">##  [9,]  3.5854137 -0.03381616 -0.07002316 -0.04718872</span></span>
<span><span class="co">## [10,]  1.0577878 -0.03381616 -0.07002316 -0.04718872</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_zscore</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-pca">Step 4 PCA<a class="anchor" aria-label="anchor" href="#step-4-pca"></a>
</h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>X_obs <span class="op">=</span> scrub._E_obs_norm</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>X_sim <span class="op">=</span> scrub._E_sim_norm</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span>n_prin_comps, random_state<span class="op">=</span>random_state, svd_solver<span class="op">=</span>svd_solver).fit(X_obs)</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a>pto <span class="op">=</span> pca.transform(X_obs)</span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a>pts <span class="op">=</span> pca.transform(X_sim)</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_obs_norm</span><span class="op">)</span></span>
<span><span class="va">X_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">E_sim_norm</span><span class="op">)</span></span>
<span><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu">prcomp_irlba</span><span class="op">(</span><span class="va">X_obs</span>, n <span class="op">=</span> <span class="va">n_prin_comps</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">ix</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_obs</span><span class="op">)</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>py <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">pto</span><span class="op">[</span><span class="va">ix</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">pca</span>, <span class="va">X_obs</span><span class="op">)</span><span class="op">[</span><span class="va">ix</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">R</span>, y<span class="op">=</span><span class="va">py</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Correlation of R and Python PC values"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-24-1.png" width="100%"></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scr</span><span class="op">$</span><span class="fu">pipeline_pca</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">scr</span><span class="op">$</span><span class="fu">calculate_doublet_scores</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">scr</span><span class="op">$</span><span class="fu">call_doublets</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>scr.pipeline_pca(scrub)</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>scrub.calculate_doublet_scores(</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>            use_approx_neighbors<span class="op">=</span>use_approx_neighbors,</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>            distance_metric<span class="op">=</span>distance_metric,</span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>            get_doublet_neighbor_parents<span class="op">=</span>get_doublet_neighbor_parents</span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a>            )</span></code></pre></div>
<pre><code><span><span class="co">## array([0.05098494, 0.08314607, 0.06166561, ..., 0.09076559, 0.11131059,</span></span>
<span><span class="co">##        0.20963173])</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>scrub.call_doublets(verbose<span class="op">=</span>verbose)</span></code></pre></div>
<pre><code><span><span class="co">## Automatically set threshold at doublet score = 0.68</span></span>
<span><span class="co">## Detected doublet rate = 0.0%</span></span>
<span><span class="co">## Estimated detectable doublet fraction = 14.2%</span></span>
<span><span class="co">## Overall doublet rate:</span></span>
<span><span class="co">##  Expected   = 10.0%</span></span>
<span><span class="co">##  Estimated  = 0.3%</span></span>
<span><span class="co">## array([False, False, False, ..., False, False, False])</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>final_doublet <span class="op">=</span> scrub.doublet_scores_obs_</span></code></pre></div>
<p>Interesting that the tumor shows less correlation across the two
implementations than other celltypes</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>py <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">final_doublet</span><span class="op">)</span>, R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">doublet_scores_obs_</span><span class="op">)</span>, celltype <span class="op">=</span> <span class="va">seuP</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">R</span>, y<span class="op">=</span><span class="va">py</span>, color <span class="op">=</span> <span class="va">celltype</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Correlation of R and Python doublet scores (log transformed)"</span><span class="op">)</span><span class="op">+</span><span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">polychrome</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-27-1.png" width="100%"></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>py <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="va">final_doublet</span><span class="op">)</span>, R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">scr</span><span class="op">$</span><span class="va">doublet_scores_obs_</span><span class="op">)</span>, genotype <span class="op">=</span> <span class="va">seuP</span><span class="op">$</span><span class="va">geno</span><span class="op">)</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">R</span>, y<span class="op">=</span><span class="va">py</span>, color <span class="op">=</span> <span class="va">genotype</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.3</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Correlation of R and Python doublet scores (log transformed)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ImplementationHassles_files/figure-html/unnamed-chunk-27-2.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h3>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Ventura 13.5.2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/Los_Angeles</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] magrittr_2.0.3     scCustomize_2.0.1  Seurat_5.0.1       SeuratObject_5.0.1</span></span>
<span><span class="co">##  [5] sp_2.1-2           viewmastRust_0.1.4 scrubletR_0.1.1    pbmcapply_1.5.1   </span></span>
<span><span class="co">##  [9] ggplot2_3.4.4      irlba_2.3.5.1      RcppAnnoy_0.0.21   R6_2.5.1          </span></span>
<span><span class="co">## [13] Matrix_1.6-4       reticulate_1.34.0 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] fs_1.6.3                    matrixStats_1.1.0          </span></span>
<span><span class="co">##   [3] spatstat.sparse_3.0-3       bitops_1.0-7               </span></span>
<span><span class="co">##   [5] lubridate_1.9.3             httr_1.4.7                 </span></span>
<span><span class="co">##   [7] RColorBrewer_1.1-3          doParallel_1.0.17          </span></span>
<span><span class="co">##   [9] tools_4.3.1                 sctransform_0.4.1          </span></span>
<span><span class="co">##  [11] backports_1.4.1             utf8_1.2.4                 </span></span>
<span><span class="co">##  [13] lazyeval_0.2.2              uwot_0.1.16                </span></span>
<span><span class="co">##  [15] GetoptLong_1.0.5            withr_2.5.2                </span></span>
<span><span class="co">##  [17] gridExtra_2.3               progressr_0.14.0           </span></span>
<span><span class="co">##  [19] cli_3.6.1                   Biobase_2.60.0             </span></span>
<span><span class="co">##  [21] textshaping_0.3.7           spatstat.explore_3.2-5     </span></span>
<span><span class="co">##  [23] fastDummies_1.7.3           labeling_0.4.3             </span></span>
<span><span class="co">##  [25] prismatic_1.1.1             sass_0.4.8                 </span></span>
<span><span class="co">##  [27] spatstat.data_3.0-3         ggridges_0.5.4             </span></span>
<span><span class="co">##  [29] pbapply_1.7-2               pkgdown_2.0.7              </span></span>
<span><span class="co">##  [31] systemfonts_1.0.5           foreign_0.8-86             </span></span>
<span><span class="co">##  [33] dichromat_2.0-0.1           parallelly_1.36.0          </span></span>
<span><span class="co">##  [35] maps_3.4.1.1                pals_1.8                   </span></span>
<span><span class="co">##  [37] rstudioapi_0.15.0           generics_0.1.3             </span></span>
<span><span class="co">##  [39] shape_1.4.6                 ica_1.0-3                  </span></span>
<span><span class="co">##  [41] spatstat.random_3.2-2       dplyr_1.1.4                </span></span>
<span><span class="co">##  [43] ggbeeswarm_0.7.2            fansi_1.0.6                </span></span>
<span><span class="co">##  [45] S4Vectors_0.38.2            abind_1.4-5                </span></span>
<span><span class="co">##  [47] terra_1.7-55                lifecycle_1.0.4            </span></span>
<span><span class="co">##  [49] yaml_2.3.7                  snakecase_0.11.1           </span></span>
<span><span class="co">##  [51] SummarizedExperiment_1.30.2 recipes_1.0.8              </span></span>
<span><span class="co">##  [53] Rtsne_0.17                  paletteer_1.5.0            </span></span>
<span><span class="co">##  [55] grid_4.3.1                  promises_1.2.1             </span></span>
<span><span class="co">##  [57] crayon_1.5.2                miniUI_0.1.1.1             </span></span>
<span><span class="co">##  [59] lattice_0.22-5              cowplot_1.1.1              </span></span>
<span><span class="co">##  [61] mapproj_1.2.11              pillar_1.9.0               </span></span>
<span><span class="co">##  [63] knitr_1.45                  ComplexHeatmap_2.16.0      </span></span>
<span><span class="co">##  [65] GenomicRanges_1.52.1        rjson_0.2.21               </span></span>
<span><span class="co">##  [67] boot_1.3-28.1               future.apply_1.11.0        </span></span>
<span><span class="co">##  [69] codetools_0.2-19            leiden_0.4.3.1             </span></span>
<span><span class="co">##  [71] glue_1.6.2                  MatrixExtra_0.1.14         </span></span>
<span><span class="co">##  [73] data.table_1.14.10          float_0.3-1                </span></span>
<span><span class="co">##  [75] vctrs_0.6.5                 png_0.1-8                  </span></span>
<span><span class="co">##  [77] spam_2.10-0                 gtable_0.3.4               </span></span>
<span><span class="co">##  [79] rematch2_2.1.2              assertthat_0.2.1           </span></span>
<span><span class="co">##  [81] cachem_1.0.8                gower_1.0.1                </span></span>
<span><span class="co">##  [83] xfun_0.41                   S4Arrays_1.0.6             </span></span>
<span><span class="co">##  [85] mime_0.12                   prodlim_2023.08.28         </span></span>
<span><span class="co">##  [87] survival_3.5-7              timeDate_4022.108          </span></span>
<span><span class="co">##  [89] SingleCellExperiment_1.22.0 iterators_1.0.14           </span></span>
<span><span class="co">##  [91] hardhat_1.3.0               lava_1.7.3                 </span></span>
<span><span class="co">##  [93] ellipsis_0.3.2              fitdistrplus_1.1-11        </span></span>
<span><span class="co">##  [95] ROCR_1.0-11                 ipred_0.9-14               </span></span>
<span><span class="co">##  [97] nlme_3.1-164                GenomeInfoDb_1.36.4        </span></span>
<span><span class="co">##  [99] rprojroot_2.0.4             bslib_0.6.1                </span></span>
<span><span class="co">## [101] vipor_0.4.5                 KernSmooth_2.23-22         </span></span>
<span><span class="co">## [103] rpart_4.1.23                colorspace_2.1-0           </span></span>
<span><span class="co">## [105] BiocGenerics_0.46.0         Hmisc_5.1-1                </span></span>
<span><span class="co">## [107] nnet_7.3-19                 ggrastr_1.0.2              </span></span>
<span><span class="co">## [109] tidyselect_1.2.0            compiler_4.3.1             </span></span>
<span><span class="co">## [111] htmlTable_2.4.2             desc_1.4.2                 </span></span>
<span><span class="co">## [113] DelayedArray_0.26.7         plotly_4.10.3              </span></span>
<span><span class="co">## [115] checkmate_2.3.1             scales_1.3.0               </span></span>
<span><span class="co">## [117] lmtest_0.9-40               stringr_1.5.1              </span></span>
<span><span class="co">## [119] digest_0.6.33               goftest_1.2-3              </span></span>
<span><span class="co">## [121] spatstat.utils_3.0-4        minqa_1.2.6                </span></span>
<span><span class="co">## [123] rmarkdown_2.25              XVector_0.40.0             </span></span>
<span><span class="co">## [125] RhpcBLASctl_0.23-42         htmltools_0.5.7            </span></span>
<span><span class="co">## [127] pkgconfig_2.0.3             base64enc_0.1-3            </span></span>
<span><span class="co">## [129] lme4_1.1-35.1               sparseMatrixStats_1.12.2   </span></span>
<span><span class="co">## [131] MatrixGenerics_1.12.3       highr_0.10                 </span></span>
<span><span class="co">## [133] fastmap_1.1.1               rlang_1.1.2                </span></span>
<span><span class="co">## [135] GlobalOptions_0.1.2         htmlwidgets_1.6.4          </span></span>
<span><span class="co">## [137] shiny_1.8.0                 DelayedMatrixStats_1.22.6  </span></span>
<span><span class="co">## [139] farver_2.1.1                jquerylib_0.1.4            </span></span>
<span><span class="co">## [141] zoo_1.8-12                  jsonlite_1.8.8             </span></span>
<span><span class="co">## [143] ModelMetrics_1.2.2.2        RCurl_1.98-1.13            </span></span>
<span><span class="co">## [145] Formula_1.2-5               GenomeInfoDbData_1.2.10    </span></span>
<span><span class="co">## [147] dotCall64_1.1-1             patchwork_1.1.3            </span></span>
<span><span class="co">## [149] munsell_0.5.0               Rcpp_1.0.11                </span></span>
<span><span class="co">## [151] stringi_1.8.2               pROC_1.18.5                </span></span>
<span><span class="co">## [153] zlibbioc_1.46.0             MASS_7.3-60                </span></span>
<span><span class="co">## [155] plyr_1.8.9                  listenv_0.9.0              </span></span>
<span><span class="co">## [157] ggrepel_0.9.4               forcats_1.0.0              </span></span>
<span><span class="co">## [159] deldir_2.0-2                splines_4.3.1              </span></span>
<span><span class="co">## [161] tensor_1.5                  circlize_0.4.15            </span></span>
<span><span class="co">## [163] igraph_1.5.1                spatstat.geom_3.2-7        </span></span>
<span><span class="co">## [165] RcppHNSW_0.5.0              reshape2_1.4.4             </span></span>
<span><span class="co">## [167] stats4_4.3.1                evaluate_0.23              </span></span>
<span><span class="co">## [169] ggprism_1.0.4               nloptr_2.0.3               </span></span>
<span><span class="co">## [171] foreach_1.5.2               httpuv_1.6.13              </span></span>
<span><span class="co">## [173] RANN_2.6.1                  tidyr_1.3.0                </span></span>
<span><span class="co">## [175] purrr_1.0.2                 polyclip_1.10-6            </span></span>
<span><span class="co">## [177] future_1.33.0               clue_0.3-65                </span></span>
<span><span class="co">## [179] scattermore_1.2             janitor_2.2.0              </span></span>
<span><span class="co">## [181] xtable_1.8-4                monocle3_1.3.4             </span></span>
<span><span class="co">## [183] RSpectra_0.16-1             later_1.3.2                </span></span>
<span><span class="co">## [185] viridisLite_0.4.2           class_7.3-22               </span></span>
<span><span class="co">## [187] ragg_1.2.6                  tibble_3.2.1               </span></span>
<span><span class="co">## [189] beeswarm_0.4.0              memoise_2.0.1              </span></span>
<span><span class="co">## [191] IRanges_2.34.1              cluster_2.1.6              </span></span>
<span><span class="co">## [193] timechange_0.2.0            globals_0.16.2             </span></span>
<span><span class="co">## [195] caret_6.0-94</span></span></code></pre>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "/Users/sfurlan/develop/scrubletR/vignettes"</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://furlan-lab.github.io" class="external-link">Scott Furlan</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
